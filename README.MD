# CommentTree

REST-сервис на Go для работы с иерархическими комментариями (дерево комментариев).

Сервис позволяет:
- создавать/скрывать/удалять корневые/дочерние комментарии;
- получать коллекцию корневых комментариев с пагинацией;
- получать дерево/ветку комментариев;
- хранить данные в PostgreSQL;
- производить поиск по существующим комментариям по ключевому слову.

---

## Стек

- Golang 1.25;
- WBF-фреймфорк;
- PostgreSQL;
- Docker / Docker Compose;
- HTML + JS (UI).

## Архитектура

Проект построен по слоистой архитектуре:

```json
http → handler → service → repository → database
```

## Слои
- **model**  
  Хранилище описания доменных структур данных, используемых приложением.

- **handler**  
  HTTP-обработчики - oтвечают за:
  - парсинг входных данных;
  - валидацию query-параметров;
  - формирование HTTP-ответов.

- **service**  
  Бизнес-логика приложения:  
  - проверка корректности данных;
  - маршрутизация сценариев;
  - работа с ошибками:
    - логирование технических ошибок;
    - передача user-friendly ошибок в слой хендлера;
  - маппинг данных.

- **repository**  
  Доступ к данным (PostgreSQL).
  Содержит SQL-логику.

- **migrations**  
  Содержит инструмент для выполнения SQL-миграций при запуске приложения.


## Запуск проекта

### 1. Клонирование

```bash
git clone https://github.com/UnendingLoop/CommentTree
cd CommentTree
```

### 2. Запуск через Docker

Обязательно скопировать `.env.example` в `.env` в корне проекта и заполнить переменные окружения.

```bash
docker-compose up --build
```

После запуска сервис будет доступен по адресу:
http://localhost:8080

## Web UI

Простой одностраничный интерфейс доступен по адресу:

http://localhost:8080/web/index.html

UI поддерживает:
- просмотр списка/создание корневых комментариев и возможность отвечать на них;
- поиск по комменатриям используя ключевые слова и переход к результату.

## HTTP API

### 1. Создание комментария: **POST** `/comments`

**Request JSON:**

```json
{
  "content": "Это корневой комментарий",
  "parent_id": null
}
```

Для ответа на комментарий:

```json
{
  "content": "Это дочерний комментарий",
  "parent_id": 5
}
```

**Response (201 Created):**

```json
{
  "id": 6,
  "content": "Это корневой комментарий",
  "created_at": "2025-01-01T12:00:00Z",
  "replyable": true
}
```

```json
{
  "id": 6,
  "content": "Это дочерний комментарий",
  "parent_id": 5,
  "created_at": "2025-01-01T12:00:00Z",
  "replyable": true
}
```

---

### 2. Получение коллекции корневых комментариев: **GET** `/comments?page=N&limit=N&sort=created_at&order=ascending`

**Query-параметры(non-mandatory):**

- "page" число;
- "limit" число;
- "sort" строка:
    - "text" или "content";
	- "author";
	- "created".
- "order" строка:
    - "ascending";
    - "descending".

По умолчанию применяются следующие параметры для формирования ответа:
- "page": "1";
- "limit": "30";
- "sort": "created";
- "order": "descending".

**Response (200 OK):**

```json
[
    {
        "id": 4,
        "content": "ddd",
        "created_at": "2026-01-01T14:38:06.180745Z",
        "replyable": true
    },
    ...
    {
        "id": 1,
        "content": "aaa",
        "created_at": "2026-01-01T14:37:58.142702Z",
        "replyable": true
    }
]
```

### 3. Поиск: **GET** `/comments/search?q=apple`

**Response (200 OK):**

```json
[
    {
        "id": 6,
        "content": "apple apple",
        "created_at": "2026-01-01T14:39:26.838136Z",
        "replyable": true
    },
    {
        "id": 5,
        "content": "apple",
        "created_at": "2026-01-01T14:39:22.25225Z",
        "replyable": true
    }
]
```

### 4. Скрытие комментария (soft-delete): **GET** `/comments/id?mode=soft`

**Response (204 No Content)**

После скрытия комментария отвечать на него более невозможно, дочерние комментарии продолжают отображаться.

### 5. Удаление комментария (hard-delete): **GET** `/comments/id?mode=hard`

**Response (204 No Content)**

Удаление комменатрия производится каскадно: вместе с родителем удаляются все дети.

## Тестирование

Запуск всех тестов:

```bash
go test ./...
```
